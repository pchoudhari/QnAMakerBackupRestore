# How to run script?
# .\AddRestrictedIPAzureAppService.ps1 -ResourceGroupName "YourResourceGroup" -AppServiceName "YourAppServiceName" -SubscriptionId "YourSubscriptionGuid" 

# Sample example to run
# .\AddRestrictedIPAzureAppService.ps1 -ResourceGroupName "QnaMakerCoreTeam" -AppServiceName "QnAMakerDriTestCentralIndia" -SubscriptionId "a18d1e5d-191d-4523-85f3-fd72c8fe5d63" 

Param( 
    [Parameter(Mandatory = $true)] 
    [string] $ResourceGroupName, 
    [Parameter(Mandatory = $true)] 
    [string] $AppServiceName, 
    [Parameter(Mandatory = $true)] 
    [string] $SubscriptionId
)

# How to get below IPs?
# Download IP Ranges for all service tags:Â https://www.microsoft.com/en-us/download/details.aspx?id=56519
# Select the IPs of "CognitiveServicesManagement"
$addressPrefixes = "13.64.73.207/32","13.65.241.39/32","13.66.56.76/32","13.66.141.232/29","13.66.142.0/26","13.67.10.80/29","13.67.10.128/26","13.68.82.4/32","13.68.211.223/32","13.69.67.64/28","13.69.67.128/26","13.69.230.0/29","13.69.230.32/29","13.70.74.88/29","13.70.74.120/29","13.70.127.50/32","13.70.149.125/32","13.71.173.216/29","13.71.173.248/29","13.71.196.136/29","13.71.196.168/29","13.73.242.48/29","13.73.242.128/26","13.73.249.0/27","13.73.249.96/27","13.73.249.128/28","13.73.253.122/31","13.73.254.200/29","13.73.254.208/29","13.73.254.216/30","13.73.255.32/27","13.74.139.192/32","13.74.170.104/32","13.75.39.64/29","13.75.39.96/29","13.75.92.220/32","13.75.137.81/32","13.75.163.9/32","13.75.168.111/32","13.77.55.152/29","13.77.170.155/32","13.78.17.188/32","13.78.70.7/32","13.78.185.44/32","13.78.187.168/32","13.79.2.84/32","13.83.68.180/32","13.84.42.205/32","13.86.178.10/32","13.86.184.142/32","13.86.219.128/27","13.86.219.160/29","13.87.216.38/32","13.88.14.63/32","13.88.26.200/32","13.89.235.89/32","13.91.58.176/32","13.91.130.201/32","13.91.138.229/32","13.91.243.134/32","13.92.179.108/32","13.93.122.1/32","13.94.26.39/32","20.36.120.224/27","20.36.121.192/27","20.36.121.224/28","20.36.125.128/26","20.37.64.224/27","20.37.65.192/27","20.37.65.224/28","20.37.68.36/30","20.37.70.128/26","20.37.70.224/27","20.37.76.200/30","20.37.156.204/30","20.37.157.96/27","20.37.195.112/28","20.37.195.192/27","20.37.196.160/27","20.37.224.224/27","20.37.225.192/27","20.37.225.224/28","20.37.229.192/26","20.38.84.108/30","20.38.85.160/27","20.38.87.128/27","20.38.87.160/28","20.38.136.240/28","20.38.137.128/27","20.38.137.224/27","20.38.141.12/30","20.38.142.128/26","20.38.142.224/27","20.39.11.112/28","20.39.12.0/27","20.39.12.96/27","20.39.15.56/31","20.39.15.60/30","20.40.125.208/32","20.40.164.245/32","20.40.170.73/32","20.40.187.210/32","20.40.188.109/32","20.40.190.135/32","20.40.190.225/32","20.40.200.64/27","20.40.200.96/28","20.40.207.152/29","20.40.224.32/28","20.40.224.48/30","20.40.224.56/29","20.40.225.64/26","20.40.225.192/26","20.41.5.160/27","20.41.65.192/27","20.41.66.160/27","20.41.66.192/28","20.41.69.40/29","20.41.69.56/30","20.41.193.176/28","20.41.193.192/27","20.41.195.160/27","20.41.208.0/30","20.42.4.204/30","20.42.6.144/28","20.42.6.160/27","20.42.7.128/27","20.42.131.240/28","20.42.227.144/28","20.42.227.160/27","20.42.228.128/27","20.43.42.16/28","20.43.42.32/27","20.43.43.0/27","20.43.45.232/29","20.43.45.244/30","20.43.47.0/26","20.43.47.128/27","20.43.66.16/28","20.43.66.32/27","20.43.67.0/27","20.43.88.240/32","20.43.121.0/29","20.43.121.32/29","20.43.131.48/28","20.43.132.0/27","20.43.132.96/27","20.44.8.160/29","20.44.8.192/29","20.44.17.16/29","20.44.17.48/29","20.44.27.120/29","20.44.27.216/29","20.45.67.213/32","20.45.112.224/27","20.45.113.192/27","20.45.113.224/28","20.45.116.128/26","20.45.192.126/31","20.45.195.128/27","20.45.195.224/27","20.45.196.0/28","20.45.198.88/29","20.45.199.36/30","20.46.10.128/26","20.46.10.192/27","20.48.192.64/29","20.48.192.80/30","20.48.193.64/26","20.48.193.192/27","20.49.96.128/27","20.49.96.160/28","20.49.102.56/29","20.49.102.192/28","20.49.102.208/30","20.49.102.216/29","20.49.102.224/30","20.49.103.128/26","20.49.114.160/29","20.49.114.176/29","20.49.114.184/30","20.49.114.224/27","20.49.115.192/26","20.49.118.64/27","20.49.126.136/29","20.49.126.144/29","20.49.126.152/30","20.49.126.224/27","20.50.1.16/28","20.50.68.126/31","20.51.8.128/26","20.51.8.224/27","20.51.16.192/26","20.51.17.32/27","20.53.41.32/29","20.53.41.40/30","20.53.41.48/28","20.53.44.0/30","20.53.44.128/26","20.53.44.192/27","20.58.66.64/27","20.61.96.168/29","20.61.96.176/29","20.61.96.188/30","20.61.97.64/27","20.61.98.64/31","20.61.98.192/26","20.61.99.32/27","20.62.58.0/26","20.62.128.144/30","20.62.129.64/26","20.62.129.160/27","20.65.130.0/26","20.65.130.128/26","20.66.2.64/26","20.66.2.160/27","20.72.20.64/27","20.72.20.128/26","20.72.21.8/29","20.150.161.160/27","20.150.164.128/27","20.150.164.160/28","20.150.167.64/26","20.150.241.80/29","20.184.58.62/32","20.184.240.78/32","20.184.241.66/32","20.184.241.238/32","20.184.242.113/32","20.184.242.115/32","20.184.242.189/32","20.185.105.28/32","20.187.195.152/29","20.187.196.192/30","20.187.197.64/26","20.187.197.160/27","20.189.108.64/27","20.189.109.32/27","20.189.109.64/28","20.189.111.200/30","20.189.111.208/28","20.189.225.0/26","20.189.225.96/27","20.191.160.8/29","20.191.160.20/30","20.191.160.96/28","20.191.160.112/30","20.191.161.128/26","20.191.161.224/27","20.192.161.144/28","20.192.161.160/27","20.192.164.128/27","20.192.167.64/26","20.192.184.84/30","20.192.225.208/28","20.192.225.224/27","20.192.228.192/27","20.192.231.128/26","20.194.72.64/26","20.194.72.192/27","23.96.13.121/32","23.96.229.148/32","23.97.152.121/32","23.98.107.28/30","23.98.107.200/29","23.98.107.208/28","23.98.108.36/30","23.98.108.40/31","23.98.108.192/26","23.98.109.32/29","23.100.0.32/32","23.100.57.171/32","23.100.59.49/32","40.64.128.192/27","40.64.134.140/30","40.64.134.168/29","40.64.134.176/28","40.64.135.80/29","40.67.48.224/27","40.67.49.192/27","40.67.49.224/28","40.67.52.128/26","40.69.73.194/32","40.69.104.32/30","40.69.111.36/30","40.70.47.165/32","40.70.241.203/32","40.74.30.108/30","40.74.31.64/26","40.74.64.203/32","40.78.20.224/32","40.78.204.0/29","40.78.204.32/29","40.79.132.48/29","40.79.132.80/29","40.79.156.64/27","40.79.176.32/30","40.79.187.168/29","40.79.187.200/29","40.80.57.208/28","40.80.57.224/27","40.80.58.192/27","40.80.63.152/30","40.80.63.224/28","40.80.63.240/30","40.80.169.192/27","40.80.170.160/27","40.80.170.192/28","40.80.172.28/30","40.80.176.0/28","40.80.188.112/28","40.80.190.128/27","40.80.190.224/27","40.82.253.200/30","40.82.253.208/28","40.82.255.0/26","40.82.255.96/27","40.85.230.100/32","40.86.227.247/32","40.87.48.184/32","40.88.22.25/32","40.89.17.240/28","40.89.18.128/27","40.89.18.224/27","40.89.23.36/30","40.89.133.209/32","40.89.134.214/32","40.90.138.4/32","40.90.139.2/32","40.90.139.36/32","40.90.139.163/32","40.90.141.99/32","40.112.254.71/32","40.113.124.208/32","40.113.194.60/32","40.113.226.173/32","40.115.248.103/32","40.117.154.42/32","40.117.232.90/32","40.119.2.134/32","40.119.11.216/29","40.120.8.48/30","40.121.217.232/32","40.122.42.111/32","40.123.205.29/32","40.123.210.248/32","40.123.214.182/32","40.123.214.251/32","40.123.218.49/32","40.127.76.4/32","40.127.76.10/32","40.127.165.113/32","51.11.97.80/29","51.12.41.48/28","51.12.41.128/27","51.12.41.224/27","51.12.43.192/26","51.12.193.48/28","51.12.193.128/27","51.12.193.224/27","51.12.195.128/26","51.13.136.64/26","51.104.25.240/28","51.104.27.64/27","51.104.28.32/27","51.104.31.160/29","51.104.31.168/30","51.104.31.176/28","51.105.67.176/29","51.105.67.208/29","51.105.80.224/27","51.105.81.192/27","51.105.81.224/28","51.105.89.128/27","51.105.89.224/27","51.105.90.0/28","51.105.92.52/30","51.105.170.64/32","51.107.48.240/28","51.107.49.128/27","51.107.49.224/27","51.107.52.216/29","51.107.53.36/30","51.107.53.40/29","51.107.128.24/29","51.107.144.224/27","51.107.145.192/27","51.107.145.224/28","51.107.148.20/30","51.107.148.64/28","51.107.192.72/29","51.107.241.0/26","51.107.241.128/27","51.107.249.0/26","51.107.249.128/27","51.116.48.144/28","51.116.48.160/27","51.116.49.0/27","51.116.51.192/26","51.116.144.144/28","51.116.144.160/27","51.116.145.0/27","51.116.148.128/26","51.120.40.240/28","51.120.41.128/27","51.120.41.224/27","51.120.224.224/27","51.120.225.192/27","51.120.225.224/28","51.120.232.64/26","51.124.95.46/32","51.124.140.143/32","51.137.162.128/27","51.137.162.224/27","51.137.163.0/28","51.137.166.28/30","51.137.166.44/30","51.137.166.48/28","51.137.167.192/26","51.138.40.194/32","51.138.41.75/32","51.138.160.4/30","51.140.5.56/32","51.140.105.165/32","51.140.202.0/32","51.143.192.224/27","51.143.193.192/27","51.143.193.224/28","51.143.208.128/30","51.143.209.0/26","51.143.209.64/27","51.144.83.210/32","52.136.48.240/28","52.136.49.128/27","52.136.49.224/27","52.136.53.0/26","52.136.184.128/26","52.136.184.192/27","52.138.41.171/32","52.138.92.172/30","52.139.106.0/26","52.139.106.128/27","52.140.105.192/27","52.140.106.160/27","52.140.106.192/28","52.140.110.96/29","52.140.110.104/30","52.140.110.112/28","52.140.110.160/30","52.140.111.128/26","52.140.111.224/27","52.142.81.236/32","52.142.83.87/32","52.142.84.66/32","52.142.85.51/32","52.143.91.192/28","52.146.79.144/28","52.146.79.224/27","52.146.131.32/28","52.146.131.48/30","52.146.131.96/27","52.146.132.128/26","52.146.133.0/27","52.147.43.145/32","52.147.44.12/32","52.147.97.4/30","52.147.112.0/26","52.147.112.64/27","52.149.31.64/28","52.150.139.192/27","52.150.140.160/27","52.150.140.192/28","52.150.154.200/29","52.150.154.208/28","52.150.156.32/30","52.150.156.40/30","52.150.157.64/26","52.150.157.128/27","52.152.207.160/28","52.152.207.192/28","52.155.218.251/32","52.156.93.240/28","52.156.103.64/27","52.156.103.96/28","52.161.16.73/32","52.162.110.248/29","52.162.111.24/29","52.163.56.146/32","52.168.112.0/26","52.171.134.140/32","52.172.112.0/28","52.172.112.16/29","52.172.112.192/26","52.172.113.32/27","52.172.187.21/32","52.173.240.242/32","52.174.60.141/32","52.174.146.221/32","52.175.18.186/32","52.175.35.166/32","52.179.13.227/32","52.179.14.109/32","52.179.113.96/27","52.179.113.128/28","52.180.162.194/32","52.180.166.172/32","52.180.178.146/32","52.180.179.119/32","52.183.33.203/32","52.186.33.48/28","52.186.91.216/32","52.187.20.181/32","52.187.39.99/32","52.190.33.56/32","52.190.33.61/32","52.190.33.154/32","52.191.14.164/32","52.191.160.229/32","52.191.173.81/32","52.224.200.129/32","52.225.176.80/32","52.228.83.128/27","52.228.83.224/27","52.228.84.0/28","52.229.16.14/32","52.231.74.63/32","52.231.79.142/32","52.231.148.200/30","52.231.159.35/32","52.233.163.218/32","52.234.229.248/32","52.237.137.4/32","52.249.207.163/32","52.255.83.208/28","52.255.84.176/28","52.255.84.192/28","52.255.124.16/28","52.255.124.80/28","52.255.124.96/28","65.52.205.19/32","65.52.252.208/28","102.133.28.72/29","102.133.28.104/29","102.133.56.144/28","102.133.56.224/27","102.133.61.192/26","102.133.75.174/32","102.133.123.248/29","102.133.124.24/29","102.133.124.88/29","102.133.124.96/29","102.133.156.128/29","102.133.161.242/32","102.133.162.109/32","102.133.162.196/32","102.133.162.221/32","102.133.163.185/32","102.133.217.80/28","102.133.217.96/27","102.133.218.0/27","102.133.220.192/30","102.133.221.64/26","102.133.221.128/27","102.133.236.198/32","104.40.225.182/32","104.42.100.80/32","104.42.194.173/32","104.42.239.93/32","104.44.89.44/32","104.46.112.239/32","104.46.176.164/30","104.46.176.176/28","104.46.178.4/30","104.46.178.192/26","104.46.179.0/27","104.46.239.137/32","104.211.88.173/32","104.211.222.193/32","104.214.49.162/32","104.214.233.86/32","104.215.9.217/32","137.117.44.81/32","137.117.46.21/32","137.117.46.34/32","137.117.70.195/32","137.135.45.32/32","168.61.158.107/32","168.61.165.229/32","168.62.187.75/32","168.63.20.177/32","191.232.39.30/32","191.232.162.204/32","191.233.10.48/28","191.233.10.64/27","191.233.10.128/27","191.233.15.64/26","191.233.205.72/29","191.233.205.104/29","191.234.138.136/29","191.234.138.148/30","191.234.139.192/26","191.234.142.32/27","191.235.227.128/27","191.235.227.224/27","191.235.228.0/28","2603:1000:4::680/122","2603:1000:104::180/122","2603:1000:104::380/122","2603:1000:104:1::640/122","2603:1010:6::80/122","2603:1010:6:1::640/122","2603:1010:101::680/122","2603:1010:304::680/122","2603:1010:404::680/122","2603:1020:5::80/122","2603:1020:5:1::640/122","2603:1020:206::80/122","2603:1020:206:1::640/122","2603:1020:305::680/122","2603:1020:405::680/122","2603:1020:605::680/122","2603:1020:705::80/122","2603:1020:705:1::640/122","2603:1020:805::80/122","2603:1020:805:1::640/122","2603:1020:905::680/122","2603:1020:a04::80/122","2603:1020:a04:1::640/122","2603:1020:b04::680/122","2603:1020:c04::80/122","2603:1020:c04:1::640/122","2603:1020:d04::680/122","2603:1020:e04::80/122","2603:1020:e04:1::640/122","2603:1020:f04::680/122","2603:1020:1004::640/122","2603:1020:1004:1::80/122","2603:1020:1004:1::1f0/125","2603:1020:1004:1::300/122","2603:1020:1104::700/121","2603:1020:1104:1::150/125","2603:1030:f:1::680/122","2603:1030:10::80/122","2603:1030:10:1::640/122","2603:1030:104::80/122","2603:1030:104:1::640/122","2603:1030:107::730/125","2603:1030:107::740/122","2603:1030:107::780/122","2603:1030:210::80/122","2603:1030:210:1::640/122","2603:1030:40b:1::640/122","2603:1030:40c::80/122","2603:1030:40c:1::640/122","2603:1030:504::80/122","2603:1030:504::1f0/125","2603:1030:504::300/122","2603:1030:504:1::640/122","2603:1030:608::680/122","2603:1030:807::80/122","2603:1030:807:1::640/122","2603:1030:a07::680/122","2603:1030:b04::680/122","2603:1030:c06:1::640/122","2603:1030:f05::80/122","2603:1030:f05:1::640/122","2603:1030:1005::680/122","2603:1040:5::180/122","2603:1040:5:1::640/122","2603:1040:207::680/122","2603:1040:407::80/122","2603:1040:407:1::640/122","2603:1040:606::680/122","2603:1040:806::680/122","2603:1040:904::80/122","2603:1040:904:1::640/122","2603:1040:a06::180/122","2603:1040:a06:1::640/122","2603:1040:b04::680/122","2603:1040:c06::680/122","2603:1040:d04::640/122","2603:1040:d04:1::80/122","2603:1040:d04:1::1f0/125","2603:1040:d04:1::300/122","2603:1040:f05::80/122","2603:1040:f05:1::640/122","2603:1040:1104::700/121","2603:1040:1104:1::150/125","2603:1050:6::80/122","2603:1050:6:1::640/122","2603:1050:403::640/122"


$ErrorActionPreference = "Stop"

Import-Module Az

#If logged in, there's an azcontext, so we skip login
#if($Null -eq (Get-AzContext)){
    Login-AzAccount
#}

Select-AzSubscription -SubscriptionId $SubscriptionId

#grab the latest available api version
$APIVersion = ((Get-AzResourceProvider -ProviderNamespace Microsoft.Web).ResourceTypes | Where-Object ResourceTypeName -eq sites).ApiVersions[0]

$WebAppConfig = Get-AzResource -ResourceName $AppServiceName -ResourceType Microsoft.Web/sites/config -ResourceGroupName $ResourceGroupName -ApiVersion $APIVersion

foreach ($addressPrefix in $addressPrefixes) {
    $WebAppConfig.Properties.ipSecurityRestrictions += @{
        ipAddress = $addressPrefix; 
        action = "Allow";
        priority = "100";
        name = "cognitive service ip";
        description = "allow traffic";
        tag = "Default";
    }
}


Set-AzResource -ResourceId $WebAppConfig.ResourceId -Properties $WebAppConfig.Properties -ApiVersion $APIVersion